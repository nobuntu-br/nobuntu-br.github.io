# üì• ImportCsvComponent

## üß© Descri√ß√£o
O **ImportCsvComponent** √© um componente Angular respons√°vel por importar arquivos CSV para dentro de um **SubForm**.  
Ele permite que o usu√°rio carregue um arquivo CSV, visualize uma pr√©via dos dados, selecione quais colunas ser√£o importadas e processe os dados convertendo automaticamente os tipos conforme a configura√ß√£o JSON da classe (definida via `IPageStructure`).

Al√©m disso, o componente possui mecanismos de valida√ß√£o que garantem que o arquivo CSV corresponda aos campos configurados no JSON, incluindo a verifica√ß√£o de colunas obrigat√≥rias e a convers√£o de tipos de dados como `boolean`, `number`, `date` e `datetime`.

Se uma coluna com o nome `id` for inclu√≠da, o sistema atualizar√° o registro correspondente em vez de criar um novo.

---

## üß± Estrutura e Interfaces

### `ImportCsvDialogData`
Define os dados recebidos pelo di√°logo de importa√ß√£o.

```ts
export interface ImportCsvDialogData {
  className: string;
  jsonConfig: IPageStructure;
}
```

### `ImportCsvResult`
Estrutura retornada ap√≥s o processo de importa√ß√£o.

```ts
export interface ImportCsvResult {
  data: any[];
  settings: {
    delimiter: string;
    encoding: string;
    hasHeader: boolean;
    skipEmptyLines: boolean;
    skipEmptyColumns: boolean;
  };
}
```

---

## ‚öôÔ∏è Funcionalidades Principais

- **Upload de arquivo CSV** (arrastar e soltar ou sele√ß√£o manual)
- **Detec√ß√£o autom√°tica de delimitador** (`;`, `,`, `|`, `\t`)
- **Detec√ß√£o de encoding** (`UTF-8`, `UTF-16LE`, etc.)
- **Visualiza√ß√£o pr√©via dos dados**
- **Sele√ß√£o de colunas para importa√ß√£o**
- **Convers√£o de tipos de valores** conforme o JSON de configura√ß√£o
- **Valida√ß√£o de campos obrigat√≥rios**
- **Gera√ß√£o autom√°tica de template CSV**
- **Suporte a atualiza√ß√£o via coluna `id`**
- **Tratamento de erros e feedback visual** (barra de progresso, tooltips, mensagens de erro)

---

## üî¢ Convers√£o de Tipos

| Tipo no JSON | Convers√£o no CSV | Exemplo de Valor V√°lido |
|---------------|------------------|--------------------------|
| `boolean` | Reconhece valores como `true`, `1`, `sim`, `on`, `ativo`, etc. | `Sim`, `false`, `0` |
| `number` | Remove formata√ß√µes e converte para n√∫mero. | `1.500`, `2000`, `3,14` |
| `date` | Converte formatos comuns para ISO. | `25/12/2024`, `2024-12-25` |
| `datetime` | Similar ao date, inclui hora se presente. | `25/12/2024 14:30` |
| `string` | Mant√©m valor original. | `Texto livre` |

---

## ‚öôÔ∏è Propriedades

| Propriedade | Tipo | Descri√ß√£o |
|--------------|------|------------|
| `importForm` | `FormGroup` | Formul√°rio reativo que define as configura√ß√µes de importa√ß√£o. |
| `selectedFile` | `File` \| `null` | Arquivo CSV atualmente selecionado. |
| `previewData` | `any[][]` | Pr√©via das primeiras linhas do arquivo. |
| `colsToImport` | `boolean[]` | Define quais colunas ser√£o importadas. |
| `classAttributesNames` | `string[]` | Lista de atributos da classe (usada para gerar o template). |

---

## üßÆ M√©todos Principais

| M√©todo | Descri√ß√£o |
|---------|------------|
| `onFileSelected()` | Lida com o upload manual do arquivo. |
| `onDrop()` | Permite arrastar e soltar o arquivo CSV. |
| `processFile()` | Processa o conte√∫do do arquivo e gera a pr√©via. |
| `parseCSVContent()` | Analisa o conte√∫do e detecta estrutura e tipos. |
| `convertValueByType()` | Converte os valores com base no tipo do campo configurado. |
| `validateForRequiredColumns()` | Garante que o CSV contenha os campos obrigat√≥rios. |
| `downloadTemplate()` | Gera automaticamente um modelo CSV com base na estrutura JSON. |
| `onImport()` | Finaliza o processo e retorna os dados processados para o chamador. |

---

## üí° Exemplo de Uso

O componente √© aberto via **MatDialog** a partir de outro componente, passando as informa√ß√µes da classe e estrutura JSON:

```ts
const dialogRef = this.dialog.open(ImportCsvComponent, {
  data: {
    className: 'Produto',
    jsonConfig: this.pageStructure
  }
});

dialogRef.afterClosed().subscribe((result: ImportCsvResult | undefined) => {
  if (result) {
    console.log('Dados importados:', result.data);
  }
});
```

---

## üß† Observa√ß√µes

- O componente **verifica automaticamente** se o arquivo CSV √© v√°lido para o subform antes de importar.
- √â poss√≠vel **desmarcar colunas** que n√£o devem ser importadas.
- Caso o CSV contenha a coluna **‚Äúid‚Äù**, os registros existentes ser√£o **atualizados**, e n√£o criados novamente.
- Colunas n√£o reconhecidas ou com tipos incompat√≠veis s√£o tratadas e exibidas com **avisos (tooltips)**.

---

## üßæ Template CSV Gerado

Um template padr√£o pode ser baixado com o bot√£o **"Baixar Template"**, gerado automaticamente com base nas colunas do JSON de configura√ß√£o.

Exemplo de template gerado para a classe `Produto`:

```csv
id,nome,preco,ativo
exemplo_id,exemplo_nome,exemplo_preco,exemplo_ativo
```

---

## üì¶ Depend√™ncias

- `@angular/forms`
- `@angular/material`
- `@angular/common`
- `app/shared/models/pageStructure`

---

## ‚úçÔ∏è Autor
Desenvolvido como parte da melhoria do **SubForm Import CSV**, permitindo importa√ß√£o em massa de registros com controle de colunas e valida√ß√µes autom√°ticas.
